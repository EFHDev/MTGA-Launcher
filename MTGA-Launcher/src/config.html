<!DOCTYPE html>
<script type="module" src="/src/js/modules/defaulthtmlimports.js" defer></script>
<div data-include="../src/HTML-AddIns/launcher-settings.html"></div>
<div data-include="../src/HTML-AddIns/titlebar.html"></div>
<div data-include="../src/HTML-AddIns/sidebar.html"></div>
<html>
<link rel="stylesheet" href="/src/assets/css/styles-dark.css" id="theme-stylesheet">
<script src="https://kit.fontawesome.com/71edd74ab2.js" crossorigin="anonymous"></script>

<body>
    <div class="floating-buttons">
        <a id="back-button" class="fa-sharp fa-solid fa-arrow-left"></a>
        <a id="save-button" class="fa fa-save"></a>
    </div>
    <h1 id="title">Config Editor</h1>
    <div id="list-container">
        <table id="json-table"></table>
    </div>
    <div id="edit-container">
        <h2 id="edit-title"></h2>
        <table id="edit-table"></table>
    </div>

    <script>
        const server = localStorage.getItem('server')
        const sessionID = localStorage.getItem("SessionID");
        const saveButton = document.getElementById('save-button');
        saveButton.style.color = "red";
        saveButton.disabled = true
        fetch(`${server}/tauri/config/get`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sessionID: sessionID })
        })
            .then(response => response.json())
            .then(data => {
                let obj = data;

                const keys = Object.keys(obj);
                const listContainer = document.getElementById('list-container');
                const jsonTable = document.getElementById('json-table');
                keys.forEach(key => {
                    const row = jsonTable.insertRow();
                    const cell = row.insertCell();
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = key;
                    link.addEventListener('click', () => {
                        showEditPanel(key);
                    });
                    cell.appendChild(link);
                });

                function createTableCells(table, obj, title = null) {
                    Object.entries(obj).forEach(([key, value]) => {
                        if (key === 'ModInfo') { // hide ModInfo cell
                            return;
                        }
                        const fixedKeyName = key.replaceAll("_", " ")
                        const row = table.insertRow();
                        const cell = row.insertCell();
                        const label = document.createElement('label');
                        label.for = key;
                        label.textContent = fixedKeyName + ': ';
                        cell.appendChild(label);

                        if (typeof value === 'boolean') {
                            const input = document.createElement('input');
                            input.id = key;
                            input.type = 'checkbox';
                            input.checked = value;
                            cell.appendChild(input);
                            input.addEventListener('change', () => {
                                obj[key] = input.checked;
                                enableSaveButton();
                            });
                        } else {
                            const input = document.createElement('input');
                            input.id = key;
                            input.type = typeof value;
                            input.value = value;
                            cell.appendChild(input);
                            input.addEventListener('change', () => {
                                obj[key] = input.type === 'number' ? Number(input.value) : input.value;
                                enableSaveButton();
                            });
                        }
                    });
                    // add ModInfo label
                    if (obj.ModInfo) {
                        const ModInfo = obj.ModInfo;
                        const modInfoLabel = document.createElement('label');
                        modInfoLabel.textContent = `Generated by ${title} by ${ModInfo.Creator}:`;
                        table.insertBefore(modInfoLabel, table.firstChild);

                        const versionLabel = document.createElement('span');
                        versionLabel.textContent = `Version: ${ModInfo.Version}`;
                        const typeLabel = document.createElement('span');
                        typeLabel.textContent = `Type: ${ModInfo.Type}`;
                        const creatorLabel = document.createElement('span');
                        typeLabel.style.marginBottom = "0px";
                        creatorLabel.style.marginBottom = "0px";
                        typeLabel.style.lineHeight = "0px";
                        creatorLabel.style.lineHeight = "0px";

                        const ModInfoLabel2 = document.createElement('label');
                        ModInfoLabel2.setAttribute('for', 'modInfoLabel');
                        ModInfoLabel2.style.fontSize = "12px"
                        ModInfoLabel2.style.lineHeight = '0.1';
                        ModInfoLabel2.appendChild(document.createElement('br'));
                        ModInfoLabel2.appendChild(versionLabel);
                        ModInfoLabel2.appendChild(document.createElement('br'));
                        ModInfoLabel2.appendChild(typeLabel);

                        table.insertBefore(ModInfoLabel2, modInfoLabel.nextElementSibling);

                        if (obj.ModInfo.Type === 'AKI') { // add warning message
                            const warning = document.createElement('div');
                            warning.textContent = 'This is an AKI Mod, No support will be given!';
                            warning.style.backgroundColor = "red"
                            warning.style.borderRadius = "2px";
                            warning.style.borderColor = "white";
                            warning.style.color = 'white';
                            warning.style.fontWeight = 'bold';
                            warning.style.marginBottom = '10px';
                            table.insertBefore(warning, modInfoLabel);
                        }
                    }
                }
                function showConfigList() {
                    const editContainer = document.getElementById('edit-container');
                    const listContainer = document.getElementById('list-container');
                    const saveButton = document.getElementById('save-button');
                    const saveButton2 = document.querySelector(".fa.fa-save");
                    const warningMessage = document.getElementById('warning-message');

                    editContainer.style.display = 'none';
                    listContainer.style.display = 'block';


                    // Remove any existing warning messages
                    if (warningMessage) {
                        warningMessage.remove();
                    }

                    // Check if any of the mod configs are AKI mods and display a warning message if so
                    const keys = Object.keys(obj);
                    let isAKIMod = false;
                    keys.forEach(key => {
                        if (obj[key]?.ModInfo?.Type === 'AKI') {
                            isAKIMod = true;
                        }
                    });
                }

                function showEditPanel(key) {
                    const editContainer = document.getElementById('edit-container');
                    const editTitle = document.getElementById('edit-title');
                    const editTable = document.getElementById('edit-table');
                    const backButton = document.getElementById('back-button');
                    const saveButton = document.getElementById('save-button');
                    while (editTable.firstChild) {
                        editTable.removeChild(editTable.firstChild);
                    }
                    editTitle.editTextContent = String.prototype.replace(key, "_", " ");
                    const config = obj[key];
                    createTableCells(editTable, config, key);
                    backButton.addEventListener('click', () => {
                        showConfigList();
                    });
                    saveButton.addEventListener('click', () => {
                        saveChanges(key, config);
                    });
                    editContainer.style.display = 'block';
                    listContainer.style.display = 'none';
                }
                function enableSaveButton() {
                    const saveButton = document.getElementById('save-button');
                    saveButton.disabled = false
                    saveButton.style.color = "Green"
                }
                function saveChanges(key, config) {
                    const saveButton = document.getElementById('save-button');
                    saveButton.disabled = true;
                    fetch(`${server}/tauri/config/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sessionID: sessionID, key: key, config: config })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data === "Success") {
                                alert("Saved Successfully")
                            }
                            if (data === "NOT_EXIST") { //TODO: ACTUALLY MAKE THIS FUCKING WORK WHAT THE FUCK
                                alert("This account doesnt exist.. what the fuck?")
                            }
                        })
                        .catch(error => {
                            console.error(error);
                        });
                    (JSON.stringify(body))
                }
            })
            .catch(error => {
                console.error(error);
            });
    </script>

</body>

</html>